<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Music 01s</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:ital,wght@0,300;0,400;0,500;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../themes.css">
<script src="songs.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--ff-body); overflow: hidden; }

  .shell {
    position: relative; z-index: 1; height: 100vh;
    display: flex; flex-direction: column;
    max-width: 820px; margin: 0 auto; padding: 28px 40px 24px;
  }

  .logo {
    font-family: var(--ff-body); font-weight: 700; font-size: 2.2rem;
    color: var(--text); text-decoration: none; text-align: center;
    display: block; margin-bottom: 24px;
  }
  .logo em { color: var(--purple); font-style: normal; }

  /* 6 attempt rows filling available space */
  .attempts { display: flex; flex-direction: column; gap: 8px; flex: 1; min-height: 0; }

  .attempt-row {
    flex: 1; border-radius: 8px; background: var(--s1);
    display: flex; align-items: center; justify-content: center;
    font-family: var(--ff-body); font-size: .9rem; font-weight: 500;
    color: transparent; min-height: 0; max-height: 42px;
  }
  .attempt-row.skipped  { background: var(--s2); color: var(--muted); }
  .attempt-row.correct  { background: var(--purple); color: #fff; }
  .attempt-row.wrong    { background: var(--danger); color: #fff; }
  .attempt-row.revealed { background: var(--s2); color: var(--text); }

  /* timeline */
  .timeline-wrap { padding: 18px 0 2px; position: relative; }

  .tl-label {
    position: absolute; top: 0; transform: translateX(-50%);
    font-family: var(--ff-body); font-size: .8rem; font-weight: 600; color: var(--text);
    white-space: nowrap;
  }
  .tl-label::after {
    content: ''; display: block; width: 0; height: 0;
    border-left: 5px solid transparent; border-right: 5px solid transparent;
    border-top: 6px solid var(--text); margin: 2px auto 0;
  }

  .tl-track {
    position: relative; height: 10px; background: var(--s2); border-radius: 4px; overflow: hidden;
  }
  .tl-fill { height: 100%; background: var(--purple); border-radius: 4px; width: 0%; }

  /* segment dividers */
  .tl-segs {
    position: absolute; inset: 0; display: flex; pointer-events: none;
  }
  .tl-seg { flex: 1; border-right: 2px solid var(--bg); }
  .tl-seg:last-child { border-right: none; }

  /* play button */
  .play-wrap { display: flex; justify-content: center; padding: 16px 0 18px; }

  .play-btn {
    width: 58px; height: 58px; border-radius: 50%;
    background: var(--purple); border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: transform .1s, background .15s; flex-shrink: 0;
  }
  .play-btn:hover { background: var(--pink); }
  .play-btn:active { transform: scale(.93); }
  .play-btn svg { width: 22px; height: 22px; fill: #fff; }

  @keyframes fwin  { 0%{box-shadow:0 0 0 0 rgba(144,149,255,.6)}  100%{box-shadow:0 0 0 40px rgba(144,149,255,0)} }
  @keyframes flose { 0%{box-shadow:0 0 0 0 rgba(240,104,112,.6)} 100%{box-shadow:0 0 0 40px rgba(240,104,112,0)} }
  .flash-win  { animation: fwin  .6s ease-out; }
  .flash-lose { animation: flose .6s ease-out; }

  /* bottom controls */
  .bottom { display: flex; gap: 10px; }

  .guess-wrap { flex: 1; position: relative; }

  .guess-input {
    width: 100%; background: var(--s1); border: 1px solid var(--border);
    border-radius: 10px; padding: 14px 18px 14px 42px;
    color: var(--text); font-family: var(--ff-body); font-size: .95rem;
    outline: none; transition: border-color .2s;
  }
  .guess-input:focus { border-color: var(--border2); }
  .guess-input.has-value { border-color: var(--purple); }
  .guess-input::placeholder { color: var(--muted); }
  .guess-input:disabled { opacity: .35; cursor: not-allowed; }

  .search-icon {
    position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
    color: var(--muted); pointer-events: none; font-size: 1rem;
  }

  .ac-wrap {
    position: absolute; bottom: calc(100% + 6px); left: 0; right: 0;
    background: var(--s2); border: 1px solid var(--border2); border-radius: 12px;
    overflow: hidden; z-index: 200; display: none;
  }
  .ac-wrap.open { display: block; }
  .ac-item {
    padding: 10px 16px; cursor: pointer; transition: background .1s;
    display: flex; flex-direction: column; gap: 2px;
    border-bottom: 1px solid var(--border);
  }
  .ac-item:last-child { border-bottom: none; }
  .ac-item:hover, .ac-item.focused { background: var(--border); }
  .ac-title  { font-size: .88rem; color: var(--text); }
  .ac-artist { font-size: .66rem; color: var(--muted); font-family: var(--ff-mono); letter-spacing: .08em; }

  .btn-action {
    padding: 14px 28px; border-radius: 10px;
    font-family: var(--ff-body); font-size: .9rem; font-weight: 600;
    cursor: pointer; white-space: nowrap; transition: background .15s, border-color .15s;
  }
  .btn-skip {
    background: var(--s1); border: 1px solid var(--border); color: var(--text);
  }
  .btn-skip:hover { background: var(--s2); border-color: var(--border2); }
  .btn-skip:disabled { opacity: .25; cursor: not-allowed; }

  .btn-next {
    background: var(--purple); border: none; color: #fff;
    display: none;
  }
  .btn-next:hover { background: var(--pink); }
  .btn-next.visible { display: block; }

  .btn-confirm {
    background: var(--purple); border: none; color: #fff;
    display: none;
  }
  .btn-confirm:hover { background: var(--pink); }
  .btn-confirm.visible { display: block; }

  ::-webkit-scrollbar { width: 3px; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>
<div class="shell">
  <a href="../index.html" class="logo"><em>Music</em> 01s</a>

  <div class="attempts">
    <div class="attempt-row" id="row-0"></div>
    <div class="attempt-row" id="row-1"></div>
    <div class="attempt-row" id="row-2"></div>
    <div class="attempt-row" id="row-3"></div>
    <div class="attempt-row" id="row-4"></div>
    <div class="attempt-row" id="row-5"></div>
  </div>

  <div class="timeline-wrap" id="timelineWrap">
    <div class="tl-label" id="tlLabel" style="left:0%">0.1s</div>
    <div class="tl-track">
      <div class="tl-fill" id="tlFill"></div>
      <div class="tl-segs" id="tlSegs"></div>
    </div>
  </div>

  <div class="play-wrap">
    <button class="play-btn" id="playBtn" onclick="playClip()">
      <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
    </button>
  </div>

  <div class="bottom">
    <div class="guess-wrap" id="guessRow">
      <span class="search-icon">üîç</span>
      <input class="guess-input" id="guessInput" type="text"
        placeholder="Search a song" autocomplete="off"
        oninput="onInput()" onkeydown="onKey(event)">
      <div class="ac-wrap" id="acWrap"></div>
    </div>
    <button class="btn-action btn-skip" id="btnSkip" onclick="skipStep()">Skip</button>
    <button class="btn-action btn-confirm" id="btnConfirm" onclick="submitGuess()">‚úì</button>
    <button class="btn-action btn-next" id="btnNext" onclick="nextSong()">Next ‚Üí</button>
  </div>
</div>

<script>
const CLIPS    = [0.1, 0.5, 2, 4, 8, 16];
const TOTAL_DUR = CLIPS[CLIPS.length - 1];

let songs = typeof SONGS !== 'undefined' ? shuffle([...SONGS]) : [];
let songIdx = 0, round = 0, done = false, acIdx = -1;

const audio = new Audio();
let clipTimer = null, rafId = null, clipStart = null;
let clipState = 'idle', clipElapsed = 0, clipOnEnd = null, clipOnProg = null, clipTotalMs = 0;

window.addEventListener('DOMContentLoaded', () => {
  if (!songs.length) {
    document.querySelector('.shell').innerHTML =
      `<div style="height:100dvh;display:flex;align-items:center;justify-content:center;
         font-family:var(--ff-mono);color:var(--muted);font-size:.8rem;text-align:center;line-height:2.4">
        <div>üéµ<br>No songs found.<br>Run <code style="color:var(--text)">python build.py</code> first.</div>
      </div>`;
    return;
  }
  buildTimeline();
  loadSong();
});

function buildTimeline() {
  document.getElementById('tlSegs').innerHTML = CLIPS.map(() => `<div class="tl-seg"></div>`).join('');
}

function setTlProgress(p) { document.getElementById('tlFill').style.width = (p * 100) + '%'; }

function setTlLabel(clipIdx) {
  const dur = CLIPS[clipIdx];
  const pct = dur / TOTAL_DUR * 100;
  const lbl = document.getElementById('tlLabel');
  lbl.style.left = pct + '%';
  lbl.textContent = dur + ' seconds';
}

function loadSong() {
  if (songIdx >= songs.length) { endGame(); return; }
  round = 0; done = false;
  stopClip();
  audio.src = songs[songIdx].file; audio.load();
  for (let i = 0; i < CLIPS.length; i++) {
    const r = document.getElementById('row-' + i);
    r.className = 'attempt-row'; r.textContent = '';
  }
  document.getElementById('guessInput').value = '';
  document.getElementById('guessInput').classList.remove('has-value');
  document.getElementById('btnNext').classList.remove('visible');
  document.getElementById('btnConfirm').classList.remove('visible');
  document.getElementById('btnSkip').style.display = '';
  setInputEnabled(true); setPlayIcon(false);
  setTlProgress(0); setTlLabel(0);
  clipState = 'idle'; clipElapsed = 0;
}

function playClip() {
  if (done) return;
  if (clipState === 'playing') { pauseClip(); return; }
  if (clipState === 'paused')  { resumeClip(); return; }
  startClip(CLIPS[round],
    (p) => setTlProgress(p * (CLIPS[round] / TOTAL_DUR)),
    () => { clipState = 'idle'; setPlayIcon(false); setTlProgress(0); }
  );
}

function startClip(dur, onProgress, onEnd) {
  resetClip();
  clipTotalMs = dur * 1000; clipOnProg = onProgress; clipOnEnd = onEnd;
  clipElapsed = 0; clipState = 'playing';
  audio.currentTime = 0;
  audio.play().catch(e => console.error(e));
  setPlayIcon(true); scheduleStop(); tickProgress();
}

function pauseClip() {
  if (clipState !== 'playing') return;
  clipState = 'paused'; clipElapsed += Date.now() - clipStart;
  clearTimeout(clipTimer); cancelAnimationFrame(rafId);
  audio.pause(); setPlayIcon(false);
}

function resumeClip() {
  if (clipState !== 'paused') return;
  clipState = 'playing';
  audio.play().catch(e => console.error(e));
  setPlayIcon(true); scheduleStop(); tickProgress();
}

function scheduleStop() {
  const remaining = clipTotalMs - clipElapsed;
  clipStart = Date.now();
  clipTimer = setTimeout(() => {
    audio.pause(); audio.currentTime = 0; cancelAnimationFrame(rafId);
    clipState = 'idle'; clipElapsed = 0;
    if (clipOnProg) clipOnProg(1);
    if (clipOnEnd)  clipOnEnd();
  }, remaining);
}

function tickProgress() {
  function tick() {
    if (clipState !== 'playing') return;
    const elapsed = clipElapsed + (Date.now() - clipStart);
    const p = Math.min(elapsed / clipTotalMs, 1);
    if (clipOnProg) clipOnProg(p);
    if (p < 1) rafId = requestAnimationFrame(tick);
  }
  rafId = requestAnimationFrame(tick);
}

function resetClip() {
  clearTimeout(clipTimer); cancelAnimationFrame(rafId);
  clipState = 'idle'; clipElapsed = 0;
  if (!audio.paused) audio.pause(); audio.currentTime = 0;
}
function stopClip() { resetClip(); setPlayIcon(false); }

function skipStep() {
  document.getElementById('acWrap').classList.remove('open');
  stopClip(); setTlProgress(0);
  const row = document.getElementById('row-' + round);
  row.className = 'attempt-row skipped'; row.textContent = 'Skipped';
  round++;
  if (round >= CLIPS.length) { lose(); return; }
  setTlLabel(round);
  document.getElementById('guessInput').value = '';
  document.getElementById('guessInput').classList.remove('has-value');
}

function onInput() {
  const val = document.getElementById('guessInput').value;
  document.getElementById('guessInput').classList.toggle('has-value', val.length > 0);
  document.getElementById('btnConfirm').classList.toggle('visible', val.length > 0);
  const n = val.trim().toLowerCase();
  const ac = document.getElementById('acWrap');
  acIdx = -1;
  if (!n) { ac.classList.remove('open'); return; }
  const hits = songs.filter(s => norm(s.title).includes(n) || norm(s.artist||'').includes(n)).slice(0, 7);
  if (!hits.length) { ac.classList.remove('open'); return; }
  ac.innerHTML = hits.map(s =>
    `<div class="ac-item" data-title="${esc(s.title)}" data-artist="${esc(s.artist||'')}" onclick="pickAC(this)">
       <span class="ac-title">${esc(s.title)}</span>
       ${s.artist ? `<span class="ac-artist">${esc(s.artist)}</span>` : ''}
     </div>`).join('');
  ac.classList.add('open');
}

function pickAC(el) {
  document.getElementById('guessInput').value = el.dataset.title + (el.dataset.artist ? ' ‚Äî ' + el.dataset.artist : '');
  document.getElementById('guessInput').classList.add('has-value');
  document.getElementById('acWrap').classList.remove('open'); acIdx = -1;
}

function onKey(e) {
  const items = document.getElementById('acWrap').querySelectorAll('.ac-item');
  if      (e.key === 'ArrowDown') { acIdx = Math.min(acIdx+1, items.length-1); items.forEach((el,i) => el.classList.toggle('focused', i===acIdx)); e.preventDefault(); }
  else if (e.key === 'ArrowUp')   { acIdx = Math.max(acIdx-1, -1);              items.forEach((el,i) => el.classList.toggle('focused', i===acIdx)); e.preventDefault(); }
  else if (e.key === 'Enter')     { if (acIdx>=0 && items[acIdx]) pickAC(items[acIdx]); else submitGuess(); }
  else if (e.key === 'Escape')    { document.getElementById('acWrap').classList.remove('open'); }
}

function submitGuess() {
  document.getElementById('acWrap').classList.remove('open');
  const guess = norm(document.getElementById('guessInput').value);
  const song  = songs[songIdx];
  const correct = guess.length > 1 && (
    norm(song.title).includes(guess) || guess.includes(norm(song.title)) ||
    (song.artist && (norm(song.artist).includes(guess) || guess.includes(norm(song.artist))))
  );
  if (correct) { win(); return; }

  const row = document.getElementById('row-' + round);
  row.className = 'attempt-row wrong';
  row.textContent = document.getElementById('guessInput').value;
  round++;
  document.getElementById('guessInput').value = '';
  document.getElementById('guessInput').classList.remove('has-value');
  document.getElementById('btnConfirm').classList.remove('visible');
  stopClip(); setTlProgress(0);
  if (round >= CLIPS.length) { lose(); return; }
  setTlLabel(round);
}

function win() {
  done = true; stopClip();
  const row = document.getElementById('row-' + round);
  row.className = 'attempt-row correct';
  row.textContent = songs[songIdx].title + (songs[songIdx].artist ? ' ‚Äî ' + songs[songIdx].artist : '');
  flashBtn('win'); setInputEnabled(false); showNext();
}

function lose() {
  done = true; stopClip();
  const row = document.getElementById('row-' + round);
  row.className = 'attempt-row revealed';
  row.textContent = songs[songIdx].title + (songs[songIdx].artist ? ' ‚Äî ' + songs[songIdx].artist : '');
  flashBtn('lose'); setInputEnabled(false); showNext();
}

function setPlayIcon(playing) {
  document.getElementById('playIcon').innerHTML = playing
    ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>'
    : '<path d="M8 5v14l11-7z"/>';
}

function flashBtn(type) {
  const b = document.getElementById('playBtn');
  b.classList.remove('flash-win','flash-lose'); void b.offsetWidth;
  b.classList.add(type === 'win' ? 'flash-win' : 'flash-lose');
}

function showNext() {
  document.getElementById('btnSkip').style.display = 'none';
  document.getElementById('btnNext').classList.add('visible');
}

function setInputEnabled(on) {
  document.getElementById('guessInput').disabled = !on;
  document.getElementById('btnSkip').disabled = !on;
  if (!on) document.getElementById('btnConfirm').classList.remove('visible');
}

function nextSong() { songIdx++; loadSong(); }

function endGame() {
  document.querySelector('.shell').innerHTML = `
    <div style="height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;text-align:center">
      <div style="font-family:var(--ff-body);font-weight:700;font-size:3rem;color:var(--text)">Game Over</div>
      <div style="font-family:var(--ff-body);font-size:.9rem;color:var(--muted)">All ${songs.length} songs played</div>
      <button onclick="location.reload()"
        style="margin-top:20px;padding:14px 36px;background:var(--purple);color:#fff;border:none;
               border-radius:10px;font-family:var(--ff-body);font-weight:600;font-size:1rem;cursor:pointer">
        Play Again
      </button>
    </div>`;
}

function norm(s) { return (s||'').toLowerCase().replace(/[^a-z0-9 ]/g,'').replace(/\s+/g,' ').trim(); }
function esc(s)  { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function shuffle(a) {
  for (let i=a.length-1; i>0; i--) { const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a;
}

document.addEventListener('click', e => {
  if (!e.target.closest('#guessRow')) document.getElementById('acWrap').classList.remove('open');
});
</script>
</body>
</html>
