<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pok√©Quiz Multijoueur</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@0,300;0,400;0,500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg:      #09090b;
  --s1:      #111114;
  --s2:      #17171c;
  --border:  #222228;
  --border2: #2e2e38;
  --accent:  #c8f060;
  --danger:  #f06870;
  --text:    #e2e2ee;
  --muted:   #52526a;
  --muted2:  #38384a;
  --ff-title: 'Bebas Neue', sans-serif;
  --ff-mono:  'DM Mono', monospace;
  --ff-body:  'DM Sans', sans-serif;
}

html, body { background: var(--bg); color: var(--text); font-family: var(--ff-body); }

body {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 28px 20px 48px;
  overflow-x: hidden;
}

/* grain overlay */
body::after {
  content: ''; position: fixed; inset: 0; pointer-events: none; z-index: 9999;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
}

/* ambient orbs */
.orb { position: fixed; border-radius: 50%; filter: blur(130px); pointer-events: none; z-index: 0; }
.orb-a { width: 700px; height: 700px; top: -250px; left: -200px; background: radial-gradient(circle, rgba(200,240,96,.05) 0%, transparent 70%); }
.orb-b { width: 500px; height: 500px; bottom: -150px; right: -150px; background: radial-gradient(circle, rgba(96,208,240,.04) 0%, transparent 70%); }

.wrap { position: relative; z-index: 1; width: 100%; max-width: 680px; }

/* ===== HEADER ===== */
.header { margin-bottom: 36px; }
.header .logo {
  font-family: var(--ff-title);
  font-size: clamp(2.6rem, 8vw, 3.8rem);
  letter-spacing: .1em;
  color: var(--accent);
  line-height: 1;
  cursor: pointer;
  user-select: none;
  transition: opacity .15s;
  display: inline-block;
  text-decoration: none;
}
.header .logo:hover { opacity: .8; }

/* ===== SETUP ===== */
#setup { display: flex; flex-direction: column; gap: 12px; }

.setup-section {
  background: var(--s1);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 20px 22px;
}
.setup-section h2 {
  font-family: var(--ff-mono);
  font-size: .62rem;
  letter-spacing: .18em;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 16px;
}

.stepper { display: flex; align-items: center; gap: 0; }
.stepper-btn {
  width: 40px; height: 40px;
  border-radius: 8px;
  border: 1px solid var(--border2);
  background: var(--s2);
  color: var(--muted);
  font-size: 1.3rem; font-weight: 300;
  cursor: pointer; transition: border-color .15s, color .15s;
  display: flex; align-items: center; justify-content: center;
}
.stepper-btn:hover { border-color: var(--accent); color: var(--accent); }
.stepper-val {
  font-family: var(--ff-title);
  font-size: 2.2rem;
  letter-spacing: .06em;
  min-width: 64px;
  text-align: center;
  color: var(--text);
}

.player-inputs { display: flex; flex-direction: column; gap: 8px; }
.player-row { display: flex; align-items: center; gap: 10px; }
.player-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.player-name-input {
  flex: 1;
  background: var(--s2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 14px;
  font-family: var(--ff-body);
  font-size: .9rem;
  color: var(--text);
  outline: none;
  transition: border-color .2s;
}
.player-name-input::placeholder { color: var(--muted2); }
.player-name-input:focus { border-color: var(--border2); }

.round-options { display: flex; gap: 8px; flex-wrap: wrap; }
.round-opt {
  flex: 1; min-width: 50px;
  padding: 9px 6px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--s2);
  color: var(--muted);
  font-family: var(--ff-mono);
  font-size: .85rem;
  letter-spacing: .06em;
  cursor: pointer; text-align: center; transition: all .15s;
}
.round-opt.active { border-color: var(--accent); color: var(--accent); background: rgba(200,240,96,.06); }
.round-opt:hover { border-color: var(--border2); color: var(--text); }

.mode-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.mode-opt {
  padding: 14px 12px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--s2);
  cursor: pointer; text-align: center;
  transition: all .15s;
  display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.mode-opt:hover { border-color: var(--border2); }
.mode-opt.active { border-color: var(--accent); background: rgba(200,240,96,.06); }
.mode-opt .mode-icon { font-size: 1.4rem; }
.mode-opt .mode-title {
  font-family: var(--ff-mono);
  font-size: .72rem;
  letter-spacing: .1em;
  text-transform: uppercase;
  color: var(--text);
}
.mode-opt .mode-desc { font-size: .68rem; color: var(--muted); line-height: 1.4; }

.start-btn {
  width: 100%; padding: 16px;
  border: none; border-radius: 12px;
  background: var(--accent); color: #09090b;
  font-family: var(--ff-title);
  font-size: 1.6rem; letter-spacing: .12em;
  cursor: pointer; transition: opacity .15s, transform .1s;
}
.start-btn:hover { opacity: .88; }
.start-btn:active { transform: scale(.98); }
.start-btn:disabled { opacity: .3; cursor: default; transform: none; }

/* ===== GAME ===== */
#game { display: none; flex-direction: column; gap: 10px; }

.turn-banner {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--s1); border: 1px solid var(--border); border-radius: 12px;
  padding: 11px 16px; gap: 12px;
}
.turn-who { display: flex; align-items: center; gap: 10px; }
.turn-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
.turn-name { font-family: var(--ff-title); font-size: 1.3rem; letter-spacing: .06em; }
.turn-meta { display: flex; flex-direction: column; align-items: flex-end; gap: 3px; }
.turn-round { font-family: var(--ff-mono); font-size: .58rem; color: var(--muted); letter-spacing: .1em; }
.mode-badge {
  font-family: var(--ff-mono); font-size: .55rem; letter-spacing: .12em;
  text-transform: uppercase; padding: 2px 8px; border-radius: 20px; white-space: nowrap;
  border: 1px solid var(--border2); color: var(--muted);
}
.mode-badge.qcm { border-color: rgba(200,240,96,.3); color: var(--accent); }
.mode-badge.libre { border-color: rgba(200,240,96,.3); color: var(--accent); }

.scoreboard { display: flex; gap: 6px; flex-wrap: wrap; }
.score-chip {
  flex: 1; min-width: 72px;
  background: var(--s1); border: 1px solid var(--border);
  border-radius: 10px; padding: 8px 10px; text-align: center;
  transition: border-color .3s;
}
.score-chip.active-player { border-color: var(--accent); }
.score-chip .chip-dot { width: 6px; height: 6px; border-radius: 50%; margin: 0 auto 4px; }
.score-chip .chip-name {
  font-family: var(--ff-mono); font-size: .55rem; color: var(--muted);
  text-transform: uppercase; letter-spacing: .1em;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.score-chip .chip-score {
  font-family: var(--ff-title); font-size: 1.4rem; letter-spacing: .04em; color: var(--accent);
}

.timer-wrap { display: flex; align-items: center; gap: 10px; }
.timer-label { font-family: var(--ff-mono); font-size: .62rem; letter-spacing: .1em; color: var(--muted); text-transform: uppercase; }
.bar-outer { flex: 1; height: 2px; background: var(--border2); border-radius: 2px; overflow: hidden; }
.bar-inner { height: 100%; border-radius: 2px; background: var(--accent); transition: width 1s linear, background .5s; }
#timer-display {
  font-family: var(--ff-title); font-size: 1.4rem; letter-spacing: .04em;
  min-width: 38px; text-align: right; color: var(--text); transition: color .3s;
}
#timer-display.urgent { color: var(--danger); }
@keyframes pulse { from { opacity: 1; } to { opacity: .5; } }

.poke-card {
  background: var(--s1); border: 1px solid var(--border); border-radius: 14px;
  padding: 24px; text-align: center; position: relative;
  min-height: 200px; display: flex; align-items: center; justify-content: center; overflow: hidden;
}
.poke-id {
  position: absolute; top: 12px; left: 14px;
  font-family: var(--ff-mono); font-size: .55rem;
  letter-spacing: .12em; color: var(--muted); text-transform: uppercase;
}
.poke-img {
  width: 160px; height: 160px; object-fit: contain;
  filter: brightness(0);
  transition: filter .7s ease, transform .3s;
}
.poke-img.revealed { filter: brightness(1) drop-shadow(0 4px 16px rgba(0,0,0,.6)); }
.poke-img:hover { transform: scale(1.04); }

#result-msg {
  font-family: var(--ff-title);
  font-size: 1.5rem; letter-spacing: .08em;
  text-align: center; min-height: 2rem;
}

/* QCM buttons */
.qcm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.qcm-btn {
  background: var(--s1); border: 1px solid var(--border); border-radius: 10px;
  padding: 13px 10px; font-family: var(--ff-body); font-size: .9rem;
  color: var(--text); cursor: pointer; text-align: center; line-height: 1.3;
  transition: border-color .15s, background .15s;
}
.qcm-btn:hover:not(:disabled) { border-color: var(--accent); background: rgba(200,240,96,.06); }
.qcm-btn.correct { background: rgba(200,240,96,.12); border-color: var(--accent); color: var(--accent); }
.qcm-btn.wrong { background: rgba(240,104,112,.12); border-color: var(--danger); color: var(--danger); }
.qcm-btn:disabled { cursor: default; }
@keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.04); } 100% { transform: scale(1); } }

/* Free input */
.input-wrap { display: flex; gap: 8px; }
#pokemon-input {
  flex: 1; background: var(--s1); border: 1px solid var(--border); border-radius: 10px;
  padding: 12px 16px; font-family: var(--ff-body); font-size: .95rem;
  color: var(--text); outline: none; transition: border-color .2s;
}
#pokemon-input::placeholder { color: var(--muted2); }
#pokemon-input:focus { border-color: var(--border2); }
#pokemon-input.correct { border-color: var(--accent); background: rgba(200,240,96,.06); }
#pokemon-input.wrong { border-color: var(--danger); background: rgba(240,104,112,.06); animation: shake .4s ease; }
@keyframes shake { 0%,100% { transform: translateX(0); } 25% { transform: translateX(-7px); } 75% { transform: translateX(7px); } }

#submit-btn {
  background: var(--accent); color: #09090b; border: none; border-radius: 10px;
  padding: 12px 18px; font-family: var(--ff-mono); font-size: .7rem;
  font-weight: 500; letter-spacing: .1em; cursor: pointer;
  transition: opacity .15s, transform .1s;
}
#submit-btn:hover { opacity: .85; }
#submit-btn:active { transform: scale(.97); }
#submit-btn:disabled { opacity: .25; cursor: default; transform: none; }

#next-btn {
  display: none; width: 100%; padding: 13px;
  background: transparent; border: 1px solid var(--border2); border-radius: 10px;
  color: var(--text); font-family: var(--ff-mono); font-size: .7rem;
  letter-spacing: .12em; cursor: pointer; transition: border-color .2s, color .2s;
}
#next-btn:hover { border-color: var(--accent); color: var(--accent); }

/* ===== RESULTS ===== */
#results { display: none; flex-direction: column; align-items: center; gap: 16px; }
.results-title {
  font-family: var(--ff-title); font-size: 3.2rem; letter-spacing: .1em;
  color: var(--accent); text-align: center;
}
.podium { display: flex; align-items: flex-end; justify-content: center; gap: 8px; width: 100%; margin: 4px 0; }
.podium-col { display: flex; flex-direction: column; align-items: center; gap: 5px; flex: 1; }
.podium-bar {
  width: 100%; border-radius: 6px 6px 0 0;
  display: flex; align-items: center; justify-content: center;
  font-family: var(--ff-mono); font-size: .65rem; letter-spacing: .08em; color: #09090b;
}
.podium-name { font-family: var(--ff-mono); font-size: .6rem; text-align: center; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; }
.podium-pts { font-family: var(--ff-title); font-size: 1.1rem; letter-spacing: .04em; color: var(--accent); }
.rank-emoji { font-size: 1.2rem; }
.full-results {
  width: 100%; background: var(--s1); border: 1px solid var(--border);
  border-radius: 14px; padding: 14px 18px;
  display: flex; flex-direction: column; gap: 6px;
}
.result-row { display: flex; align-items: center; gap: 12px; padding: 8px 8px; border-radius: 8px; }
.result-row:hover { background: var(--s2); }
.result-pos { font-family: var(--ff-mono); font-size: .7rem; min-width: 28px; color: var(--muted); letter-spacing: .06em; }
.result-pos.gold { color: #FFD700; } .result-pos.silver { color: #C0C0C0; } .result-pos.bronze { color: #CD7F32; }
.result-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.result-name { flex: 1; font-family: var(--ff-body); font-size: .9rem; color: var(--text); }
.result-frac { font-family: var(--ff-mono); font-size: .62rem; color: var(--muted); letter-spacing: .06em; }
.result-pct { font-family: var(--ff-title); font-size: 1.3rem; letter-spacing: .04em; color: var(--accent); }
.play-again-btn {
  width: 100%; padding: 15px; border: none; border-radius: 12px;
  background: var(--accent); color: #09090b;
  font-family: var(--ff-title); font-size: 1.5rem; letter-spacing: .12em;
  cursor: pointer; transition: opacity .15s, transform .1s;
}
.play-again-btn:hover { opacity: .88; }
.play-again-btn:active { transform: scale(.98); }

/* Loader */
.loader-wrap { display: flex; flex-direction: column; align-items: center; gap: 16px; padding: 48px; color: var(--muted); font-family: var(--ff-mono); font-size: .65rem; letter-spacing: .1em; text-transform: uppercase; }
.pokeball { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(180deg, var(--danger) 50%, var(--text) 50%); border: 3px solid var(--border2); position: relative; animation: spin 1s linear infinite; }
.pokeball::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 3px; background: var(--border2); transform: translateY(-50%); }
.pokeball::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); width: 12px; height: 12px; background: var(--text); border-radius: 50%; border: 3px solid var(--border2); }
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

/* Confetti */
.confetti-container { position: fixed; inset: 0; pointer-events: none; overflow: hidden; z-index: 9998; }
.confetti-piece { position: absolute; top: -20px; animation: confettiFall linear forwards; border-radius: 2px; }
@keyframes confettiFall { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
</style>
</head>
<body>
<div class="orb orb-a"></div>
<div class="orb orb-b"></div>
<div class="wrap">
  <div class="header">
    <a href="../index.html" class="logo">POK√âQUIZ</a>
  </div>

  <!-- SETUP -->
  <div id="setup">
    <div id="loading-wrap" class="loader-wrap">
      <div class="pokeball"></div>
      <div>Chargement des Pok√©mon...</div>
    </div>

    <div id="setup-form" style="display:none; flex-direction:column; gap:20px;">

      <div class="setup-section">
        <h2>üë• Nombre de Joueurs</h2>
        <div class="stepper">
          <button class="stepper-btn" id="players-down">‚àí</button>
          <div class="stepper-val" id="players-val">2</div>
          <button class="stepper-btn" id="players-up">+</button>
        </div>
      </div>

      <div class="setup-section">
        <h2>‚úèÔ∏è Noms des Joueurs</h2>
        <div class="player-inputs" id="player-inputs"></div>
      </div>

      <div class="setup-section">
        <h2>üî¢ Pok√©mon par Joueur</h2>
        <div class="round-options" id="round-opts">
          <div class="round-opt" data-val="5">5</div>
          <div class="round-opt active" data-val="10">10</div>
          <div class="round-opt" data-val="15">15</div>
          <div class="round-opt" data-val="20">20</div>
        </div>
      </div>

      <div class="setup-section">
        <h2>üéÆ Mode de Jeu</h2>
        <div class="mode-options" id="game-mode-opts">
          <div class="mode-opt active" data-mode="qcm">
            <div class="mode-icon">üî§</div>
            <div class="mode-title">QCM</div>
            <div class="mode-desc">4 propositions, 1 seule bonne r√©ponse</div>
          </div>
          <div class="mode-opt" data-mode="libre">
            <div class="mode-icon">‚å®Ô∏è</div>
            <div class="mode-title">Saisie libre</div>
            <div class="mode-desc">Tapez le nom du Pok√©mon</div>
          </div>
        </div>
      </div>

      <div class="setup-section">
        <h2>üñºÔ∏è Image</h2>
        <div class="mode-options" id="image-mode-opts">
          <div class="mode-opt active" data-imgmode="shadow">
            <div class="mode-icon">üïµÔ∏è</div>
            <div class="mode-title">Silhouette</div>
            <div class="mode-desc">Image assombrie, devinez sans voir</div>
          </div>
          <div class="mode-opt" data-imgmode="real">
            <div class="mode-icon">üåà</div>
            <div class="mode-title">Image r√©elle</div>
            <div class="mode-desc">Le Pok√©mon visible d√®s le d√©part</div>
          </div>
        </div>
      </div>

      <button class="start-btn" id="start-btn">‚ö° COMMENCER !</button>
    </div>
  </div>

  <!-- GAME -->
  <div id="game">
    <div class="turn-banner">
      <div class="turn-who">
        <div class="turn-dot" id="turn-dot"></div>
        <div class="turn-name" id="turn-name">Joueur</div>
      </div>
      <div class="turn-meta">
        <div class="turn-round" id="turn-round">Pok√©mon 1/10</div>
        <div class="mode-badge" id="mode-badge">QCM</div>
      </div>
    </div>

    <div class="scoreboard" id="scoreboard"></div>

    <div class="timer-wrap">
      <span class="timer-label">‚è±</span>
      <div class="bar-outer"><div class="bar-inner" id="timer-bar" style="width:100%"></div></div>
      <span id="timer-display">15s</span>
    </div>

    <div class="poke-card" id="poke-card">
      <div class="pokeball"></div>
    </div>

    <div id="result-msg"></div>

    <!-- QCM mode -->
    <div id="qcm-area" style="display:none;">
      <div class="qcm-grid" id="qcm-grid"></div>
    </div>

    <!-- Free input mode -->
    <div id="input-area" style="display:none;">
      <div class="input-wrap">
        <input type="text" id="pokemon-input" placeholder="Entrez le nom du Pok√©mon..." autocomplete="off" spellcheck="false" />
        <button id="submit-btn">OK ‚úì</button>
      </div>
    </div>

    <button id="next-btn">SUIVANT ‚ûú</button>
  </div>

  <!-- RESULTS -->
  <div id="results">
    <div class="results-title">üèÜ R√âSULTATS</div>
    <div class="podium" id="podium"></div>
    <div class="full-results" id="full-results"></div>
    <button class="play-again-btn" id="play-again-btn">üîÑ REJOUER</button>
  </div>
</div>

<div class="confetti-container" id="confetti"></div>

<script>
// ===== CONFIG =====
const MAX_TIME = 10;
const COLORS = ['#E3350D','#2A75BB','#27ae60','#9b59b6','#e67e22','#1abc9c','#e91e63','#ff9800'];

// ===== STATE =====
let allPokemon = [];
let frCache = {};
let players = [];
let numPlayers = 2;
let pokemonPerPlayer = 10;
let gameMode = 'qcm'; // 'qcm' | 'libre'
let imageMode = 'shadow'; // 'shadow' | 'real'
let globalTurn = 0;
let totalTurns = 0;
let currentPlayerIdx = 0;
let currentRound = 0;
let currentPokemon = null;
let currentOptions = []; // for QCM
let answered = false;
let timerInterval = null;
let questionStartTime = 0;
let timeLeft = MAX_TIME;
let decks = [];

// ===== LOAD =====
async function loadPokemon() {
  const res = await fetch('https://pokeapi.co/api/v2/pokemon?limit=1025');
  const data = await res.json();
  allPokemon = data.results.map((p, i) => ({
    id: i + 1,
    name: p.name,
    img: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${i + 1}.png`
  }));
  document.getElementById('loading-wrap').style.display = 'none';
  document.getElementById('setup-form').style.display = 'flex';
  renderPlayerInputs();
}

async function getFrName(id) {
  if (frCache[id]) return frCache[id];
  const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}/`);
  const data = await res.json();
  const fr = data.names.find(n => n.language.name === 'fr');
  const name = fr ? fr.name : (data.names.find(n => n.language.name === 'en')?.name || String(id));
  frCache[id] = name;
  return name;
}

// ===== SETUP =====
function renderPlayerInputs() {
  const container = document.getElementById('player-inputs');
  const existing = [...container.querySelectorAll('.player-name-input')].map(i => i.value);
  container.innerHTML = '';
  for (let i = 0; i < numPlayers; i++) {
    const row = document.createElement('div');
    row.className = 'player-row';
    const dot = document.createElement('div');
    dot.className = 'player-dot';
    dot.style.background = COLORS[i];
    const input = document.createElement('input');
    input.className = 'player-name-input';
    input.type = 'text';
    input.placeholder = `Joueur ${i + 1}`;
    input.value = existing[i] || '';
    row.appendChild(dot);
    row.appendChild(input);
    container.appendChild(row);
  }
}

document.getElementById('players-down').onclick = () => {
  if (numPlayers > 1) { numPlayers--; document.getElementById('players-val').textContent = numPlayers; renderPlayerInputs(); }
};
document.getElementById('players-up').onclick = () => {
  if (numPlayers < 8) { numPlayers++; document.getElementById('players-val').textContent = numPlayers; renderPlayerInputs(); }
};
document.getElementById('round-opts').addEventListener('click', e => {
  const opt = e.target.closest('.round-opt');
  if (!opt) return;
  document.querySelectorAll('.round-opt').forEach(o => o.classList.remove('active'));
  opt.classList.add('active');
  pokemonPerPlayer = parseInt(opt.dataset.val);
});
document.getElementById('game-mode-opts').addEventListener('click', e => {
  const opt = e.target.closest('.mode-opt');
  if (!opt) return;
  document.querySelectorAll('#game-mode-opts .mode-opt').forEach(o => o.classList.remove('active'));
  opt.classList.add('active');
  gameMode = opt.dataset.mode;
});
document.getElementById('image-mode-opts').addEventListener('click', e => {
  const opt = e.target.closest('.mode-opt');
  if (!opt) return;
  document.querySelectorAll('#image-mode-opts .mode-opt').forEach(o => o.classList.remove('active'));
  opt.classList.add('active');
  imageMode = opt.dataset.imgmode;
});
document.getElementById('start-btn').onclick = startGame;

// ===== START =====
function pickRandom(arr, n) {
  const copy = [...arr];
  const out = [];
  for (let i = 0; i < n && copy.length; i++) {
    const idx = Math.floor(Math.random() * copy.length);
    out.push(copy.splice(idx, 1)[0]);
  }
  return out;
}

async function startGame() {
  const inputs = document.querySelectorAll('.player-name-input');
  players = Array.from({ length: numPlayers }, (_, i) => ({
    name: inputs[i]?.value.trim() || `Joueur ${i + 1}`,
    color: COLORS[i],
    score: 0
  }));
  decks = players.map(() => pickRandom(allPokemon, pokemonPerPlayer));
  globalTurn = 0;
  totalTurns = numPlayers * pokemonPerPlayer;

  const btn = document.getElementById('start-btn');
  btn.textContent = 'Chargement...';
  btn.disabled = true;

  // Pre-fetch all French names
  const allIds = [...new Set(decks.flat().map(p => p.id))];
  await Promise.all(allIds.map(id => getFrName(id)));

  document.getElementById('setup').style.display = 'none';
  const gameEl = document.getElementById('game');
  gameEl.style.display = 'flex';
  gameEl.style.flexDirection = 'column';

  renderScoreboard();
  loadQuestion();
}

// ===== SCOREBOARD =====
function renderScoreboard() {
  document.getElementById('scoreboard').innerHTML = players.map((p, i) => `
    <div class="score-chip ${i === currentPlayerIdx ? 'active-player' : ''}">
      <div class="chip-dot" style="background:${p.color}"></div>
      <div class="chip-name">${p.name}</div>
      <div class="chip-score">${Number.isInteger(p.score) ? p.score : p.score.toFixed(1)}</div>
    </div>
  `).join('');
}

// ===== QUESTION =====
async function loadQuestion() {
  answered = false;
  clearInterval(timerInterval);
  document.getElementById('result-msg').textContent = '';
  document.getElementById('next-btn').style.display = 'none';

  currentPlayerIdx = globalTurn % numPlayers;
  currentRound = Math.floor(globalTurn / numPlayers);

  const player = players[currentPlayerIdx];
  const pokemon = decks[currentPlayerIdx][currentRound];
  const nameFr = await getFrName(pokemon.id);
  currentPokemon = { ...pokemon, nameFr };

  // Turn banner
  document.getElementById('turn-dot').style.background = player.color;
  document.getElementById('turn-name').textContent = player.name;
  document.getElementById('turn-round').textContent =
    `Pok√©mon ${currentRound + 1}/${pokemonPerPlayer} ‚Äî ${player.name}`;
  const badge = document.getElementById('mode-badge');
  badge.textContent = gameMode === 'qcm' ? 'üî§ QCM' : '‚å®Ô∏è Saisie libre';
  badge.className = 'mode-badge ' + gameMode;

  renderScoreboard();

  // Pok√©mon image
  const imgClass = imageMode === 'real' ? 'poke-img revealed' : 'poke-img';
  document.getElementById('poke-card').innerHTML = `
    <span class="poke-id">#${String(currentPokemon.id).padStart(3, '0')}</span>
    <img class="${imgClass}" src="${currentPokemon.img}" alt="?" />
  `;

  if (gameMode === 'qcm') {
    await renderQCM();
  } else {
    renderInput(player);
  }

  startTimer();
}

// ===== QCM MODE =====
async function renderQCM() {
  document.getElementById('qcm-area').style.display = 'block';
  document.getElementById('input-area').style.display = 'none';
  document.getElementById('qcm-grid').innerHTML = '<div style="color:#888;text-align:center;padding:10px;grid-column:span 2">Chargement...</div>';

  // Pick 3 random wrong answers
  const wrong = pickRandom(
    allPokemon.filter(p => p.id !== currentPokemon.id),
    3
  );

  // Fetch French names for all wrong options (correct one already cached)
  await Promise.all(wrong.map(p => getFrName(p.id)));

  const options = [currentPokemon, ...wrong].map(p => ({
    id: p.id,
    nameFr: frCache[p.id] || p.name
  }));

  // Shuffle
  currentOptions = options.sort(() => Math.random() - 0.5);

  document.getElementById('qcm-grid').innerHTML = currentOptions.map(opt => `
    <button class="qcm-btn" data-id="${opt.id}" onclick="handleQCM(${opt.id})">
      ${opt.nameFr}
    </button>
  `).join('');
}

function handleQCM(pokemonId) {
  if (answered) return;
  const isCorrect = pokemonId === currentPokemon.id;

  // Highlight buttons
  document.querySelectorAll('.qcm-btn').forEach(btn => {
    btn.disabled = true;
    const btnId = parseInt(btn.dataset.id);
    if (btnId === currentPokemon.id) btn.classList.add('correct');
    else if (btnId === pokemonId && !isCorrect) btn.classList.add('wrong');
  });

  processAnswer(isCorrect, false);
}

// ===== FREE INPUT MODE =====
function renderInput(player) {
  document.getElementById('qcm-area').style.display = 'none';
  document.getElementById('input-area').style.display = 'block';

  const input = document.getElementById('pokemon-input');
  const submitBtn = document.getElementById('submit-btn');
  input.value = '';
  input.className = '';
  input.disabled = false;
  input.placeholder = `${player.name}, c'est quel Pok√©mon ?`;
  submitBtn.disabled = false;
  submitBtn.onclick = submitFreeAnswer;
  input.onkeydown = e => { if (e.key === 'Enter') submitFreeAnswer(); };
  setTimeout(() => input.focus(), 50);
}

function normalize(str) {
  return str.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
}

function submitFreeAnswer() {
  if (answered) return;
  const val = document.getElementById('pokemon-input').value.trim();
  if (!val) return;
  const isCorrect = normalize(val) === normalize(currentPokemon.nameFr);
  const input = document.getElementById('pokemon-input');
  const submitBtn = document.getElementById('submit-btn');
  input.disabled = true;
  submitBtn.disabled = true;
  input.classList.add(isCorrect ? 'correct' : 'wrong');
  processAnswer(isCorrect, false);
}

// ===== TIMER =====
function startTimer() {
  timeLeft = MAX_TIME;
  questionStartTime = performance.now();
  updateTimerUI();
  timerInterval = setInterval(() => {
    timeLeft--;
    updateTimerUI();
    if (timeLeft <= 0) { clearInterval(timerInterval); if (!answered) processAnswer(false, true); }
  }, 1000);
}

function updateTimerUI() {
  const display = document.getElementById('timer-display');
  const bar = document.getElementById('timer-bar');
  if (!display || !bar) return;
  display.textContent = timeLeft + 's';
  bar.style.width = (timeLeft / MAX_TIME * 100) + '%';
  const urgent = timeLeft <= 5;
  bar.style.background = urgent
    ? 'var(--danger)'
    : 'var(--accent)';
  display.classList.toggle('urgent', urgent);
}

// ===== PROCESS ANSWER =====
function processAnswer(isCorrect, timedOut) {
  answered = true;
  clearInterval(timerInterval);

  const player = players[currentPlayerIdx];
  const elapsed = (performance.now() - questionStartTime) / 1000;
  const timeUsed = Math.min(elapsed, MAX_TIME);
  const rawPoints = isCorrect ? Math.max(0, (MAX_TIME - timeUsed) / MAX_TIME * 100) : 0;
  const pointsEarned = Math.round(rawPoints * 100) / 100; // keep 2 decimals
  player.score = Math.round((player.score + pointsEarned) * 100) / 100;

  // Reveal Pok√©mon (only animate if shadow mode ‚Äî real mode already visible)
  const img = document.querySelector('.poke-img');
  if (img && imageMode === 'shadow') img.classList.add('revealed');

  // If timed out in QCM: highlight correct answer
  if (timedOut && gameMode === 'qcm') {
    document.querySelectorAll('.qcm-btn').forEach(btn => {
      btn.disabled = true;
      if (parseInt(btn.dataset.id) === currentPokemon.id) btn.classList.add('correct');
    });
  }
  // If timed out in libre: show red border on input
  if (timedOut && gameMode === 'libre') {
    const input = document.getElementById('pokemon-input');
    input.disabled = true;
    document.getElementById('submit-btn').disabled = true;
    input.classList.add('wrong');
  }

  const msg = document.getElementById('result-msg');
  if (timedOut) {
    msg.textContent = `‚è∞ Temps ! C'√©tait ${currentPokemon.nameFr}`;
    msg.style.color = '#e67e22';
  } else if (isCorrect) {
    const displayPts = Number.isInteger(pointsEarned) ? pointsEarned : pointsEarned.toFixed(2);
    msg.textContent = `‚úÖ +${displayPts} pts ‚Äî Bravo ${player.name} !`;
    msg.style.color = '#27ae60';
  } else {
    msg.textContent = `‚ùå C'√©tait ${currentPokemon.nameFr} !`;
    msg.style.color = '#c0392b';
  }

  renderScoreboard();

  const nextBtn = document.getElementById('next-btn');
  nextBtn.style.display = 'block';
  globalTurn++;

  if (globalTurn >= totalTurns) {
    nextBtn.textContent = 'üèÜ VOIR LES R√âSULTATS';
    nextBtn.onclick = showResults;
  } else {
    const nextPlayerIdx = globalTurn % numPlayers;
    nextBtn.textContent = `‚ûú Au tour de ${players[nextPlayerIdx].name}`;
    nextBtn.onclick = loadQuestion;
  }
}

// ===== RESULTS =====
function showResults() {
  document.getElementById('game').style.display = 'none';
  const resultsEl = document.getElementById('results');
  resultsEl.style.display = 'flex';
  resultsEl.style.flexDirection = 'column';

  const sorted = [...players].sort((a, b) => b.score - a.score);

  const podiumEl = document.getElementById('podium');
  if (sorted.length === 1) {
    const p = sorted[0];
    const pct = Math.round(p.score / (pokemonPerPlayer * 100) * 100);
    podiumEl.innerHTML = `
      <div class="podium-col" style="max-width:200px;">
        <div class="rank-emoji">üèÖ</div>
        <div class="podium-name">${p.name}</div>
        <div class="podium-pts">${Number.isInteger(p.score) ? p.score : p.score.toFixed(2)} pts</div>
        <div class="podium-bar" style="height:160px; background:${p.color}">
          <span style="text-shadow:1px 1px 3px #00000099">${pct}%</span>
        </div>
      </div>
    `;
  } else if (sorted.length >= 3) {
    const order = [sorted[1], sorted[0], sorted[2]];
    const heights = [120, 165, 90];
    const emojis = ['ü•à', 'ü•á', 'ü•â'];
    podiumEl.innerHTML = order.map((p, i) => `
      <div class="podium-col">
        <div class="rank-emoji">${emojis[i]}</div>
        <div class="podium-name">${p.name}</div>
        <div class="podium-pts">${Number.isInteger(p.score) ? p.score : p.score.toFixed(2)} pts</div>
        <div class="podium-bar" style="height:${heights[i]}px; background:${p.color}">
          <span style="text-shadow:1px 1px 3px #00000099">${Math.round(p.score / (pokemonPerPlayer * 100) * 100)}%</span>
        </div>
      </div>
    `).join('');
  } else {
    const order = [sorted[1], sorted[0]];
    const heights = [110, 160];
    const emojis = ['ü•à', 'ü•á'];
    podiumEl.innerHTML = order.map((p, i) => `
      <div class="podium-col">
        <div class="rank-emoji">${emojis[i]}</div>
        <div class="podium-name">${p.name}</div>
        <div class="podium-pts">${Number.isInteger(p.score) ? p.score : p.score.toFixed(2)} pts</div>
        <div class="podium-bar" style="height:${heights[i]}px; background:${p.color}">
          <span style="text-shadow:1px 1px 3px #00000099">${Math.round(p.score / (pokemonPerPlayer * 100) * 100)}%</span>
        </div>
      </div>
    `).join('');
  }

  const posClass = ['gold', 'silver', 'bronze'];
  const posLabel = ['ü•á', 'ü•à', 'ü•â'];
  document.getElementById('full-results').innerHTML = sorted.map((p, i) => `
    <div class="result-row">
      <div class="result-pos ${posClass[i] || ''}">${posLabel[i] || `${i + 1}.`}</div>
      <div class="result-dot" style="background:${p.color}"></div>
      <div class="result-name">${p.name}</div>
      <div class="result-frac">${Number.isInteger(p.score) ? p.score : p.score.toFixed(2)} pts</div>
      <div class="result-pct">${Math.round(p.score / (pokemonPerPlayer * 100) * 100)}%</div>
    </div>
  `).join('');

  spawnConfetti();
}

document.getElementById('play-again-btn').onclick = () => {
  clearConfetti();
  players = [];
  globalTurn = 0;
  document.getElementById('results').style.display = 'none';
  document.getElementById('setup').style.display = 'flex';
  const btn = document.getElementById('start-btn');
  btn.textContent = '‚ö° COMMENCER !';
  btn.disabled = false;
  renderPlayerInputs();
};

// ===== CONFETTI =====
function spawnConfetti() {
  const container = document.getElementById('confetti');
  container.innerHTML = '';
  const colors = ['#c8f060','#f06870','#60d0f0','#ffffff','#c8f060','#f0b860'];
  for (let i = 0; i < 90; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.cssText = `
      left: ${Math.random() * 100}vw;
      background: ${colors[Math.floor(Math.random() * colors.length)]};
      width: ${7 + Math.random() * 9}px;
      height: ${7 + Math.random() * 9}px;
      animation-duration: ${2.5 + Math.random() * 3}s;
      animation-delay: ${Math.random() * 2}s;
    `;
    container.appendChild(el);
  }
}
function clearConfetti() { document.getElementById('confetti').innerHTML = ''; }

// ===== HOME =====
function goHome() {
  clearInterval(timerInterval);
  clearConfetti();
  players = [];
  globalTurn = 0;
  document.getElementById('game').style.display = 'none';
  document.getElementById('results').style.display = 'none';
  document.getElementById('setup').style.display = 'flex';
  const btn = document.getElementById('start-btn');
  btn.textContent = '‚ö° COMMENCER !';
  btn.disabled = false;
  renderPlayerInputs();
}

// ===== INIT =====
loadPokemon().catch(err => {
  document.getElementById('loading-wrap').innerHTML =
    `<div style="color:var(--red);text-align:center">‚ùå Erreur de chargement.<br>${err.message}</div>`;
});
</script>
</body>
</html>
